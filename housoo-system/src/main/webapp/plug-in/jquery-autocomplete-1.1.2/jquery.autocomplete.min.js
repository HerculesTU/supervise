(function(O){O.fn.extend({"AutoComplete":function(Q){return this.each(function(){if(!(this&&this.tagName==="INPUT"&&this.type==="text")){return}if(this.controller){this.controller.setOption(Q)}else{if(O.isPlainObject(Q)){this.controller=new N(this,Q)}}})}});var N=function(R,Q){this.option=O.extend(false,{"width":320,"maxHeight":null,"itemHeight":null,"listStyle":"normal","listDirection":"down","data":[],"ajaxDataType":"json","ajaxParams":{},"ajaxTimeout":3000,"ajaxType":"GET","maxItems":20,"matchHandler":G,"emphasisHandler":J,"createItemHandler":null,"beforeLoadDataHandler":null,"afterSelectedHandler":null,"async":false,"emphasis":true,"onerror":null},Q);K.apply(this,[R]);C.apply(this)};var K=function(R){var Q=this;this.inputView=O(R);this.inputView.attr("autocomplete","off").keyup(this._keyup=function(S){switch(S.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:A.apply(Q);break;default:if(Q.option.async){setTimeout(function(){E.apply(Q)},0)}else{E.apply(Q)}}}).keydown(this._keydown=function(T){switch(T.keyCode){case 38:B.apply(Q,["up"]);break;case 40:B.apply(Q,["down"]);break;case 13:var S=Q.searchView.is(":visible");L.apply(Q);if(S){return false}break}}).blur(this._blur=function(){O(document).one("click",function(){A.apply(Q)})})};var C=function(){var Q=this;this.searchView=O("<div class='ac'><ul></ul></div>").appendTo(document.body).on("mouseenter","li",function(){Q.searchView.find("li.selected").removeClass("selected");O(this).addClass("selected")}).on("mouseleave","li",function(){O(this).removeClass("selected")}).on("click","li",function(){L.apply(Q);A.apply(Q)}).css("font-size",this.inputView.css("font-size"));O(window).resize(function(){D.apply(Q)})};var F=function(S){var R=this,Q=this.searchView.find("ul").empty();if(O.inArray(this.option.listStyle,["normal","iconList","custom"])==-1){throw ["遇到未知的listStyle参数！"]}O.each(S,function(W,U){var T=O("<li><div></div></li>").appendTo(Q).addClass(R.option.listStyle).data("data",U).find("div");switch(R.option.listStyle){case"normal":T.append("<span>"+U.label+"</span>");break;case"iconList":var V=O("<img></img>").attr("src",U.image);T.append(O("<div></div>").append(V)).append("<span>"+U.label+"</span>");break;case"custom":T.append(R.option.createItemHandler.apply(R,[W,U]));case"default":break}if(R.option.itemHeight>0){T.height(R.option.itemHeight).css("max-height",R.option.itemHeight)}})};var D=function(){if(this.option.listDirection==="down"){var Q=this.inputView.offset().top+this.inputView.outerHeight()}else{if(this.option.listDirection==="up"){var Q=this.inputView.offset().top-this.searchView.outerHeight()}else{throw"遇到未知的listDirection参数！"}}var R=this.inputView.offset().left;this.searchView.css("top",Q+"px").css("left",R+"px")};var P=function(){if(typeof(this.option.width)==="string"&&this.option.width.toLowerCase()==="auto"){return this.inputView.outerWidth()-2}else{if(typeof(this.option.width)==="number"){return this.option.width}else{throw"遇到未知的width参数！"}}};var I=function(S){var R=this;if(this.option.listDirection==="up"){S=S.reverse()}try{F.apply(R,[S]);if(this.option.maxHeight>0){this.searchView.css("max-height",this.option.maxHeight+"px");if(O.browser.msie){this.searchView.css("height",this.searchView.height()>this.option.maxHeight?this.option.maxHeight+"px":"auto")}}D.apply(this);this.searchView.css("width",P.apply(this)+"px")}catch(Q){H.apply(this,[Q+""]);return}this.searchView.show();B.apply(this,[this.option.listDirection])};var A=function(){this.searchView.find("ul").empty();this.searchView.hide()};var B=function(R){var T=this.searchView.find("li.selected");if(T.size()){var S=R==="up"?T.prev():T.next()}else{var S=R==="up"?this.searchView.find("li").last():this.searchView.find("li").first()}if(S.size()){this.searchView.find("li").removeClass("selected");S.addClass("selected");var U=S.outerHeight();var Q=S.position().top;if(U+Q>this.searchView.height()){this.searchView.scrollTop(this.searchView.scrollTop()+Q+U-this.searchView.height())}else{if(Q<0){this.searchView.scrollTop(this.searchView.scrollTop()+Q)}}}};var L=function(){var Q=this,S=this.searchView.find("li.selected");if(S.size()){var R=S.data("data");this.inputView.val(R.value);if(O.isFunction(this.option.afterSelectedHandler)){try{this.option.afterSelectedHandler.apply(Q,[R])}catch(T){H.apply(this,["调用afterSelectedHandler错误:"+T]);return}}A.apply(this)}};var M=function(S){jQuery.support.cors=true;var R=this,T=[],Q={"async":false,"dataType":R.option.ajaxDataType,"type":R.option.ajaxType,"timeout":this.option.ajaxTimeout,"success":function(W,V,U){if(R.option.ajaxDataType==="xml"){O(W).find("item").each(function(){var X={"value":O(this).text(),"label":O(this).text()};for(var Z=0;Z<this.attributes.length;Z++){var Y=this.attributes[Z].nodeName,a=this.attributes[Z].nodeValue;X[Y]=a}T.push(X)})}else{if(R.option.ajaxDataType==="json"){T=W}else{throw"遇到未知的ajaxDataType参数！"}}},"error":function(W,V,U){throw U}};if(O.isPlainObject(this.option.ajaxParams)){Q["data"]=O.extend(false,{"keyword":S},this.option.ajaxParams)}else{if(O.isFunction(this.option.ajaxParams)){Q["data"]=O.extend(false,{"keyword":S},this.option.ajaxParams.apply(this,[S]))}else{if(typeof(this.option.ajaxParams)==="string"){Q["data"]="keyword="+S+"&"+this.option.ajaxParams}else{throw"遇到未知的ajaxParams参数！"}}}O.ajax(this.option.data,Q);return T};var E=function(){var U=this,R=this.inputView.val(),V=[],Q=true,S=[];if(O.trim(R).length==0){A.apply(U);return}if(O.isFunction(this.option.beforeLoadDataHandler)){try{Q=this.option.beforeLoadDataHandler.apply(this,[R])}catch(T){H.apply(this,["调用beforeLoadDataHandler错误:"+T]);return}}if(Q){if(O.isArray(this.option.data)){V=this.option.data}else{if(O.isFunction(this.option.data)){try{V=this.option.data.apply(this,[R])}catch(T){H.apply(this,["调用data错误:"+T]);return}}else{if(typeof(this.option.data)==="string"){try{V=M.apply(this,[R])}catch(T){H.apply(this,["Ajax错误:"+T]);return}}else{H.apply(this,["遇到未知的data参数！"]);return}}}}O.each(V,function(W,X){if(U.option.maxItems>0&&S.length>=U.option.maxItems){return false}if(O.isPlainObject(X)){var Y=O.extend(false,{},X)}else{if(typeof(X)==="string"){var Y={"label":X,"value":X,"image":X}}else{H.apply(U,["数据源Item类型错误！"]);return false}}if(U.option.matchHandler.apply(U,[R,Y])){S.push(Y)}});if(R==this.inputView.val()){if(S.length>0){I.apply(this,[S])}else{A.apply(this)}}};var H=function(Q){if(O.isFunction(this.option.onerror)){this.option.onerror.apply(this,[Q])}};N.prototype.setOption=function(Q){if(O.isPlainObject(Q)){this.option=O.extend(false,this.option,Q)}else{if(typeof(Q)==="string"){switch(Q){case"destroy":this.destroy();break;case"show":this.show();break;default:H.apply(this,["未知的AutoComplete参数！"]);return}}else{H.apply(this,["未知的AutoComplete参数类型！"]);return}}};N.prototype.destroy=function(){this.searchView.remove();this.inputView.unbind("keyup",this._keyup).unbind("keydown",this._keydown).unbind("blur",this._blur);delete this.inputView.get(0).controller};N.prototype.show=function(){if(this.option.async){setTimeout(function(){E.apply(this)},0)}else{E.apply(this)}};var G=function(S,R){var Q=RegExp(S.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i");if(this.option.emphasis&&O.isFunction(this.option.emphasisHandler)){this.option.emphasisHandler.apply(this,[S,R])}return Q.test(R.value)};var J=function(S,R){var Q=RegExp("("+S.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");R.label=R.label.replace(Q,"<em>$1</em>")}})(jQuery);