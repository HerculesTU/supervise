(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../htmlmixed/htmlmixed"],A)}else{A(CodeMirror)}}})(function(A){var B=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];A.defineMode("soy",function(C){var E=A.getMode(C,"text/plain");var G={html:A.getMode(C,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:false}),attributes:E,text:E,uri:E,css:A.getMode(C,"text/css"),js:A.getMode(C,{name:"text/javascript",statementIndent:2*C.indentUnit})};function F(L){return L[L.length-1]}function D(Q,O,P){var N=Q.string;var M=P.exec(N.substr(Q.pos));if(M){Q.string=N.substr(0,Q.pos+M.index)}var L=Q.hideFirstChars(O.indent,function(){return O.localMode.token(Q,O.localState)});Q.string=N;return L}function H(L,M){while(L){if(L.element===M){return true}L=L.next}return false}function J(L,M){return{element:M,next:L}}function I(M,L,N){return H(M,L)?"variable-2":(N?"variable":"variable-2 error")}function K(L){if(L.scopes){L.variables=L.scopes.element;L.scopes=L.scopes.next}}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:null,scopes:null,indent:0,localMode:G.html,localState:A.startState(G.html)}},copyState:function(L){return{tag:L.tag,kind:L.kind.concat([]),kindTag:L.kindTag.concat([]),soyState:L.soyState.concat([]),templates:L.templates,variables:L.variables,scopes:L.scopes,indent:L.indent,localMode:L.localMode,localState:A.copyState(L.localMode,L.localState)}},token:function(O,N){var L;switch(F(N.soyState)){case"comment":if(O.match(/^.*?\*\//)){N.soyState.pop()}else{O.skipToEnd()}return"comment";case"templ-def":if(L=O.match(/^\.?([\w]+(?!\.[\w]+)*)/)){N.templates=J(N.templates,L[1]);N.scopes=J(N.scopes,N.variables);N.soyState.pop();return"def"}O.next();return null;case"templ-ref":if(L=O.match(/^\.?([\w]+)/)){N.soyState.pop();if(L[0][0]=="."){return I(N.templates,L[1],true)}return"variable"}O.next();return null;case"param-def":if(L=O.match(/^([\w]+)(?=:)/)){N.variables=J(N.variables,L[1]);N.soyState.pop();N.soyState.push("param-type");return"def"}O.next();return null;case"param-type":if(O.peek()=="}"){N.soyState.pop();return null}if(O.eatWhile(/^[\w]+/)){return"variable-3"}O.next();return null;case"var-def":if(L=O.match(/^\$([\w]+)/)){N.variables=J(N.variables,L[1]);N.soyState.pop();return"def"}O.next();return null;case"tag":if(O.match(/^\/?}/)){if(N.tag=="/template"||N.tag=="/deltemplate"){K(N);N.indent=0}else{if(N.tag=="/for"||N.tag=="/foreach"){K(N)}N.indent-=C.indentUnit*(O.current()=="/}"||B.indexOf(N.tag)==-1?2:1)}N.soyState.pop();return"keyword"}else{if(O.match(/^([\w?]+)(?==)/)){if(O.current()=="kind"&&(L=O.match(/^="([^"]+)/,false))){var M=L[1];N.kind.push(M);N.kindTag.push(N.tag);N.localMode=G[M]||G.html;N.localState=A.startState(N.localMode)}return"attribute"}else{if(O.match(/^"/)){N.soyState.push("string");return"string"}}}if(L=O.match(/^\$([\w]+)/)){return I(N.variables,L[1])}if(L=O.match(/^\w+/)){return/^(?:as|and|or|not|in)$/.test(L[0])?"keyword":null}O.next();return null;case"literal":if(O.match(/^(?=\{\/literal})/)){N.indent-=C.indentUnit;N.soyState.pop();return this.token(O,N)}return D(O,N,/\{\/literal}/);case"string":var L=O.match(/^.*?("|\\[\s\S])/);if(!L){O.skipToEnd()}else{if(L[1]=='"'){N.soyState.pop()}}return"string"}if(O.match(/^\/\*/)){N.soyState.push("comment");return"comment"}else{if(O.match(O.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/)){return"comment"}else{if(O.match(/^\{literal}/)){N.indent+=C.indentUnit;N.soyState.push("literal");return"keyword"}else{if(L=O.match(/^\{([\/@\\]?[\w?]*)/)){if(L[1]!="/switch"){N.indent+=(/^(\/|(else|elseif|ifempty|case|default)$)/.test(L[1])&&N.tag!="switch"?1:2)*C.indentUnit}N.tag=L[1];if(N.tag=="/"+F(N.kindTag)){N.kind.pop();N.kindTag.pop();N.localMode=G[F(N.kind)]||G.html;N.localState=A.startState(N.localMode)}N.soyState.push("tag");if(N.tag=="template"||N.tag=="deltemplate"){N.soyState.push("templ-def")}if(N.tag=="call"||N.tag=="delcall"){N.soyState.push("templ-ref")}if(N.tag=="let"){N.soyState.push("var-def")}if(N.tag=="for"||N.tag=="foreach"){N.scopes=J(N.scopes,N.variables);N.soyState.push("var-def")}if(N.tag.match(/^@param\??/)){N.soyState.push("param-def")}return"keyword"}}}}return D(O,N,/\{|\s+\/\/|\/\*/)},indent:function(O,L){var N=O.indent,M=F(O.soyState);if(M=="comment"){return A.Pass}if(M=="literal"){if(/^\{\/literal}/.test(L)){N-=C.indentUnit}}else{if(/^\s*\{\/(template|deltemplate)\b/.test(L)){return 0}if(/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(L)){N-=C.indentUnit}if(O.tag!="switch"&&/^\{(case|default)\b/.test(L)){N-=C.indentUnit}if(/^\{\/switch\b/.test(L)){N-=C.indentUnit}}if(N&&O.localMode.indent){N+=O.localMode.indent(O.localState,L)}return N},innerMode:function(L){if(L.soyState.length&&F(L.soyState)!="literal"){return null}else{return{state:L.localState,mode:L.localMode}}},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:false,fold:"indent"}},"htmlmixed");A.registerHelper("hintWords","soy",B.concat(["delpackage","namespace","alias","print","css","debugger"]));A.defineMIME("text/x-soy","soy")});