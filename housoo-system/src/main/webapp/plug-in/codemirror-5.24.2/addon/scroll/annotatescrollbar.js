(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],A)}else{A(CodeMirror)}}})(function(A){A.defineExtension("annotateScrollbar",function(C){if(typeof C=="string"){C={className:C}}return new B(this,C)});A.defineOption("scrollButtonHeight",0);function B(F,E){this.cm=F;this.options=E;this.buttonHeight=E.scrollButtonHeight||F.getOption("scrollButtonHeight");this.annotations=[];this.doRedraw=this.doUpdate=null;this.div=F.getWrapperElement().appendChild(document.createElement("div"));this.div.style.cssText="position: absolute; right: 0; top: 0; z-index: 7; pointer-events: none";this.computeScale();function D(G){clearTimeout(C.doRedraw);C.doRedraw=setTimeout(function(){C.redraw()},G)}var C=this;F.on("refresh",this.resizeHandler=function(){clearTimeout(C.doUpdate);C.doUpdate=setTimeout(function(){if(C.computeScale()){D(20)}},100)});F.on("markerAdded",this.resizeHandler);F.on("markerCleared",this.resizeHandler);if(E.listenForChanges!==false){F.on("change",this.changeHandler=function(){D(250)})}}B.prototype.computeScale=function(){var D=this.cm;var C=(D.getWrapperElement().clientHeight-D.display.barHeight-this.buttonHeight*2)/D.getScrollerElement().scrollHeight;if(C!=this.hScale){this.hScale=C;return true}};B.prototype.update=function(C){this.annotations=C;this.redraw()};B.prototype.redraw=function(Q){if(Q!==false){this.computeScale()}var R=this.cm,L=this.hScale;var P=document.createDocumentFragment(),G=this.annotations;var T=R.getOption("lineWrapping");var I=T&&R.defaultTextHeight()*1.5;var D=null,H=null;function E(U,V){if(D!=U.line){D=U.line;H=R.getLineHandle(D)}if((H.widgets&&H.widgets.length)||(T&&H.height>I)){return R.charCoords(U,"local")[V?"top":"bottom"]}var W=R.heightAtLine(H,"local");return W+(V?0:H.height)}var M=R.lastLine();if(R.display.barWidth){for(var F=0,N;F<G.length;F++){var K=G[F];if(K.to.line>M){continue}var O=N||E(K.from,true)*L;var J=E(K.to,false)*L;while(F<G.length-1){if(G[F+1].to.line>M){break}N=E(G[F+1].from,true)*L;if(N>J+0.9){break}K=G[++F];J=E(K.to,false)*L}if(J==O){continue}var S=Math.max(J-O,3);var C=P.appendChild(document.createElement("div"));C.style.cssText="position: absolute; right: 0px; width: "+Math.max(R.display.barWidth-1,2)+"px; top: "+(O+this.buttonHeight)+"px; height: "+S+"px";C.className=this.options.className;if(K.id){C.setAttribute("annotation-id",K.id)}}}this.div.textContent="";this.div.appendChild(P)};B.prototype.clear=function(){this.cm.off("refresh",this.resizeHandler);this.cm.off("markerAdded",this.resizeHandler);this.cm.off("markerCleared",this.resizeHandler);if(this.changeHandler){this.cm.off("change",this.changeHandler)}this.div.parentNode.removeChild(this.div)}});