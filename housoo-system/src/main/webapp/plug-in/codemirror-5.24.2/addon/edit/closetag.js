(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"),require("../fold/xml-fold"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../fold/xml-fold"],A)}else{A(CodeMirror)}}})(function(G){G.defineOption("autoCloseTags",false,function(L,K,J){if(J!=G.Init&&J){L.removeKeyMap("autoCloseTags")}if(!K){return}var I={name:"autoCloseTags"};if(typeof K!="object"||K.whenClosing){I["'/'"]=function(M){return D(M)}}if(typeof K!="object"||K.whenOpening){I["'>'"]=function(M){return H(M)}}L.addKeyMap(I)});var B=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];var C=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function H(R){if(R.getOption("disableInput")){return G.Pass}var V=R.listSelections(),P=[];for(var M=0;M<V.length;M++){if(!V[M].empty()){return G.Pass}var W=V[M].head,Y=R.getTokenAt(W);var S=G.innerMode(R.getMode(),Y.state),N=S.state;if(S.mode.name!="xml"||!N.tagName){return G.Pass}var X=R.getOption("autoCloseTags"),Q=S.mode.configuration=="html";var K=(typeof X=="object"&&X.dontCloseTags)||(Q&&B);var U=(typeof X=="object"&&X.indentTags)||(Q&&C);var O=N.tagName;if(Y.end>W.ch){O=O.slice(0,O.length-Y.end+W.ch)}var L=O.toLowerCase();if(!O||Y.type=="string"&&(Y.end!=W.ch||!/[\"\']/.test(Y.string.charAt(Y.string.length-1))||Y.string.length==1)||Y.type=="tag"&&N.type=="closeTag"||Y.string.indexOf("/")==(Y.string.length-1)||K&&A(K,L)>-1||F(R,O,W,N,true)){return G.Pass}var T=U&&A(U,L)>-1;P[M]={indent:T,text:">"+(T?"\n\n":"")+"</"+O+">",newPos:T?G.Pos(W.line+1,0):G.Pos(W.line,W.ch+1)}}for(var M=V.length-1;M>=0;M--){var I=P[M];R.replaceRange(I.text,V[M].head,V[M].anchor,"+insert");var J=R.listSelections().slice(0);J[M]={head:I.newPos,anchor:I.newPos};R.setSelections(J);if(I.indent){R.indentLine(I.newPos.line,null,true);R.indentLine(I.newPos.line+1,null,true)}}}function E(N,I){var M=N.listSelections(),O=[];var S=I?"/":"</";for(var P=0;P<M.length;P++){if(!M[P].empty()){return G.Pass}var Q=M[P].head,J=N.getTokenAt(Q);var K=G.innerMode(N.getMode(),J.state),R=K.state;if(I&&(J.type=="string"||J.string.charAt(0)!="<"||J.start!=Q.ch-1)){return G.Pass}var L;if(K.mode.name!="xml"){if(N.getMode().name=="htmlmixed"&&K.mode.name=="javascript"){L=S+"script"}else{if(N.getMode().name=="htmlmixed"&&K.mode.name=="css"){L=S+"style"}else{return G.Pass}}}else{if(!R.context||!R.context.tagName||F(N,R.context.tagName,Q,R)){return G.Pass}L=S+R.context.tagName}if(N.getLine(Q.line).charAt(J.end)!=">"){L+=">"}O[P]=L}N.replaceSelections(O);M=N.listSelections();for(var P=0;P<M.length;P++){if(P==M.length-1||M[P].head.line<M[P+1].head.line){N.indentLine(M[P].head.line)}}}function D(I){if(I.getOption("disableInput")){return G.Pass}return E(I,true)}G.commands.closeTag=function(I){return E(I)};function A(K,L){if(K.indexOf){return K.indexOf(L)}for(var I=0,J=K.length;I<J;++I){if(K[I]==L){return I}}return -1}function F(L,S,Q,O,N){if(!G.scanForClosingTag){return false}var K=Math.min(L.lastLine()+1,Q.line+500);var I=G.scanForClosingTag(L,Q,null,K);if(!I||I.tag!=S){return false}var M=O.context;for(var P=N?1:0;M&&M.tagName==S;M=M.prev){++P}Q=I.to;for(var R=1;R<P;R++){var J=G.scanForClosingTag(L,Q,null,K);if(!J||J.tag!=S){return false}Q=J.to}return true}});