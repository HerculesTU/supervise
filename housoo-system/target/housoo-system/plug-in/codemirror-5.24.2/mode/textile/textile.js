(function(A){if(typeof exports=="object"&&typeof module=="object"){A(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],A)}else{A(CodeMirror)}}})(function(J){var C={addition:"positive",attributes:"attribute",bold:"strong",cite:"keyword",code:"atom",definitionList:"number",deletion:"negative",div:"punctuation",em:"em",footnote:"variable",footCite:"qualifier",header:"header",html:"comment",image:"string",italic:"em",link:"link",linkDefinition:"link",list1:"variable-2",list2:"variable-3",list3:"keyword",notextile:"string-2",pre:"operator",p:"property",quote:"bracket",span:"quote",specialChar:"tag",strong:"strong",sub:"builtin",sup:"builtin",table:"variable-3",tableHeading:"operator"};function B(O,N){N.mode=D.newLayout;N.tableHeading=false;if(N.layoutType==="definitionList"&&N.spanningLayout&&O.match(F("definitionListEnd"),false)){N.spanningLayout=false}}function H(R,Q,P){if(P==="_"){if(R.eat("_")){return A(R,Q,"italic",/__/,2)}else{return A(R,Q,"em",/_/,1)}}if(P==="*"){if(R.eat("*")){return A(R,Q,"bold",/\*\*/,2)}return A(R,Q,"strong",/\*/,1)}if(P==="["){if(R.match(/\d+\]/)){Q.footCite=true}return E(Q)}if(P==="("){var O=R.match(/^(r|tm|c)\)/);if(O){return I(Q,C.specialChar)}}if(P==="<"&&R.match(/(\w+)[^>]+>[^<]+<\/\1>/)){return I(Q,C.html)}if(P==="?"&&R.eat("?")){return A(R,Q,"cite",/\?\?/,2)}if(P==="="&&R.eat("=")){return A(R,Q,"notextile",/==/,2)}if(P==="-"&&!R.eat("-")){return A(R,Q,"deletion",/-/,1)}if(P==="+"){return A(R,Q,"addition",/\+/,1)}if(P==="~"){return A(R,Q,"sub",/~/,1)}if(P==="^"){return A(R,Q,"sup",/\^/,1)}if(P==="%"){return A(R,Q,"span",/%/,1)}if(P==="@"){return A(R,Q,"code",/@/,1)}if(P==="!"){var N=A(R,Q,"image",/(?:\([^\)]+\))?!/,1);R.match(/^:\S+/);return N}return E(Q)}function A(R,P,N,U,T){var Q=R.pos>T?R.string.charAt(R.pos-T-1):null;var S=R.peek();if(P[N]){if((!S||/\W/.test(S))&&Q&&/\S/.test(Q)){var O=E(P);P[N]=false;return O}}else{if((!Q||/\W/.test(Q))&&S&&/\S/.test(S)&&R.match(new RegExp("^.*\\S"+U.source+"(?:\\W|$)"),false)){P[N]=true;P.mode=D.attributes}}return E(P)}function E(P){var O=M(P);if(O){return O}var N=[];if(P.layoutType){N.push(C[P.layoutType])}N=N.concat(L(P,"addition","bold","cite","code","deletion","em","footCite","image","italic","link","span","strong","sub","sup","table","tableHeading"));if(P.layoutType==="header"){N.push(C.header+"-"+P.header)}return N.length?N.join(" "):null}function M(O){var N=O.layoutType;switch(N){case"notextile":case"code":case"pre":return C[N];default:if(O.notextile){return C.notextile+(N?(" "+C[N]):"")}return null}}function I(Q,O){var P=M(Q);if(P){return P}var N=E(Q);if(O){return N?(N+" "+O):O}else{return N}}function L(P){var O=[];for(var N=1;N<arguments.length;++N){if(P[arguments[N]]){O.push(C[arguments[N]])}}return O}function K(Q){var P=Q.spanningLayout,N=Q.layoutType;for(var O in Q){if(Q.hasOwnProperty(O)){delete Q[O]}}Q.mode=D.newLayout;if(P){Q.layoutType=N;Q.spanningLayout=true}}var G={cache:{},single:{bc:"bc",bq:"bq",definitionList:/- [^(?::=)]+:=+/,definitionListEnd:/.*=:\s*$/,div:"div",drawTable:/\|.*\|/,foot:/fn\d+/,header:/h[1-6]/,html:/\s*<(?:\/)?(\w+)(?:[^>]+)?>(?:[^<]+<\/\1>)?/,link:/[^"]+":\S/,linkDefinition:/\[[^\s\]]+\]\S+/,list:/(?:#+|\*+)/,notextile:"notextile",para:"p",pre:"pre",table:"table",tableCellAttributes:/[\/\\]\d+/,tableHeading:/\|_\./,tableText:/[^"_\*\[\(\?\+~\^%@|-]+/,text:/[^!"_=\*\[\(<\?\+~\^%@-]+/},attributes:{align:/(?:<>|<|>|=)/,selector:/\([^\(][^\)]+\)/,lang:/\[[^\[\]]+\]/,pad:/(?:\(+|\)+){1,2}/,css:/\{[^\}]+\}/},createRe:function(N){switch(N){case"drawTable":return G.makeRe("^",G.single.drawTable,"$");case"html":return G.makeRe("^",G.single.html,"(?:",G.single.html,")*","$");case"linkDefinition":return G.makeRe("^",G.single.linkDefinition,"$");case"listLayout":return G.makeRe("^",G.single.list,F("allAttributes"),"*\\s+");case"tableCellAttributes":return G.makeRe("^",G.choiceRe(G.single.tableCellAttributes,F("allAttributes")),"+\\.");case"type":return G.makeRe("^",F("allTypes"));case"typeLayout":return G.makeRe("^",F("allTypes"),F("allAttributes"),"*\\.\\.?","(\\s+|$)");case"attributes":return G.makeRe("^",F("allAttributes"),"+");case"allTypes":return G.choiceRe(G.single.div,G.single.foot,G.single.header,G.single.bc,G.single.bq,G.single.notextile,G.single.pre,G.single.table,G.single.para);case"allAttributes":return G.choiceRe(G.attributes.selector,G.attributes.css,G.attributes.lang,G.attributes.align,G.attributes.pad);default:return G.makeRe("^",G.single[N])}},makeRe:function(){var P="";for(var N=0;N<arguments.length;++N){var O=arguments[N];P+=(typeof O==="string")?O:O.source}return new RegExp(P)},choiceRe:function(){var N=[arguments[0]];for(var O=1;O<arguments.length;++O){N[O*2-1]="|";N[O*2]=arguments[O]}N.unshift("(?:");N.push(")");return G.makeRe.apply(null,N)}};function F(N){return(G.cache[N]||(G.cache[N]=G.createRe(N)))}var D={newLayout:function(P,N){if(P.match(F("typeLayout"),false)){N.spanningLayout=false;return(N.mode=D.blockType)(P,N)}var O;if(!M(N)){if(P.match(F("listLayout"),false)){O=D.list}else{if(P.match(F("drawTable"),false)){O=D.table}else{if(P.match(F("linkDefinition"),false)){O=D.linkDefinition}else{if(P.match(F("definitionList"))){O=D.definitionList}else{if(P.match(F("html"),false)){O=D.html}}}}}}return(N.mode=(O||D.text))(P,N)},blockType:function(Q,P){var O,N;P.layoutType=null;if(O=Q.match(F("type"))){N=O[0]}else{return(P.mode=D.text)(Q,P)}if(O=N.match(F("header"))){P.layoutType="header";P.header=parseInt(O[0][1])}else{if(N.match(F("bq"))){P.layoutType="quote"}else{if(N.match(F("bc"))){P.layoutType="code"}else{if(N.match(F("foot"))){P.layoutType="footnote"}else{if(N.match(F("notextile"))){P.layoutType="notextile"}else{if(N.match(F("pre"))){P.layoutType="pre"}else{if(N.match(F("div"))){P.layoutType="div"}else{if(N.match(F("table"))){P.layoutType="table"}}}}}}}}P.mode=D.attributes;return E(P)},text:function(P,O){if(P.match(F("text"))){return E(O)}var N=P.next();if(N==='"'){return(O.mode=D.link)(P,O)}return H(P,O,N)},attributes:function(O,N){N.mode=D.layoutLength;if(O.match(F("attributes"))){return I(N,C.attributes)}else{return E(N)}},layoutLength:function(O,N){if(O.eat(".")&&O.eat(".")){N.spanningLayout=true}N.mode=D.text;return E(N)},list:function(Q,P){var N=Q.match(F("list"));P.listDepth=N[0].length;var O=(P.listDepth-1)%3;if(!O){P.layoutType="list1"}else{if(O===1){P.layoutType="list2"}else{P.layoutType="list3"}}P.mode=D.attributes;return E(P)},link:function(O,N){N.mode=D.text;if(O.match(F("link"))){O.match(/\S+/);return I(N,C.link)}return E(N)},linkDefinition:function(O,N){O.skipToEnd();return I(N,C.linkDefinition)},definitionList:function(O,N){O.match(F("definitionList"));N.layoutType="definitionList";if(O.match(/\s*$/)){N.spanningLayout=true}else{N.mode=D.attributes}return E(N)},html:function(O,N){O.skipToEnd();return I(N,C.html)},table:function(O,N){N.layoutType="table";return(N.mode=D.tableCell)(O,N)},tableCell:function(O,N){if(O.match(F("tableHeading"))){N.tableHeading=true}else{O.eat("|")}N.mode=D.tableCellAttributes;return E(N)},tableCellAttributes:function(O,N){N.mode=D.tableText;if(O.match(F("tableCellAttributes"))){return I(N,C.attributes)}else{return E(N)}},tableText:function(O,N){if(O.match(F("tableText"))){return E(N)}if(O.peek()==="|"){N.mode=D.tableCell;return E(N)}return H(O,N,O.next())}};J.defineMode("textile",function(){return{startState:function(){return{mode:D.newLayout}},token:function(O,N){if(O.sol()){B(O,N)}return N.mode(O,N)},blankLine:K}});J.defineMIME("text/x-textile","textile")});