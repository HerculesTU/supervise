(function(L){L.fn.extend({"AutoComplete":function(Q){return this.each(function(){if(!(this&&this.tagName==="INPUT"&&this.type==="text")){return}if(this.controller){this.controller.setOption(Q)}else{if(L.isPlainObject(Q)){this.controller=new N(this,Q)}}})}});var N=function(R,Q){this.option=L.extend(false,{"width":320,"maxHeight":null,"itemHeight":null,"listStyle":"normal","listDirection":"down","data":[],"ajaxDataType":"json","ajaxParams":{},"ajaxTimeout":3000,"ajaxType":"GET","maxItems":20,"matchHandler":A,"emphasisHandler":G,"createItemHandler":null,"beforeLoadDataHandler":null,"afterSelectedHandler":null,"async":false,"emphasis":true,"onerror":null},Q);I.apply(this,[R]);P.apply(this)};var I=function(R){var Q=this;this.inputView=L(R);this.inputView.attr("autocomplete","off").keyup(this._keyup=function(S){switch(S.keyCode){case 13:case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:K.apply(Q);break;default:if(Q.option.async){setTimeout(function(){F.apply(Q)},0)}else{F.apply(Q)}}}).keydown(this._keydown=function(S){switch(S.keyCode){case 38:E.apply(Q,["up"]);break;case 40:E.apply(Q,["down"]);break;case 13:var T=Q.searchView.is(":visible");B.apply(Q);if(T){return false}break}}).blur(this._blur=function(){L(document).one("click",function(){K.apply(Q)})})};var P=function(){var Q=this;this.searchView=L("<div class='ac'><ul></ul></div>").appendTo(document.body).on("mouseenter","li",function(){Q.searchView.find("li.selected").removeClass("selected");L(this).addClass("selected")}).on("mouseleave","li",function(){L(this).removeClass("selected")}).on("click","li",function(){B.apply(Q);K.apply(Q)}).css("font-size",this.inputView.css("font-size"));L(window).resize(function(){O.apply(Q)})};var M=function(Q){var S=this,R=this.searchView.find("ul").empty();if(L.inArray(this.option.listStyle,["normal","iconList","custom"])==-1){throw ["遇到未知的listStyle参数！"]}L.each(Q,function(U,W){var T=L("<li><div></div></li>").appendTo(R).addClass(S.option.listStyle).data("data",W).find("div");switch(S.option.listStyle){case"normal":T.append("<span>"+W.label+"</span>");break;case"iconList":var V=L("<img></img>").attr("src",W.image);T.append(L("<div></div>").append(V)).append("<span>"+W.label+"</span>");break;case"custom":T.append(S.option.createItemHandler.apply(S,[U,W]));case"default":break}if(S.option.itemHeight>0){T.height(S.option.itemHeight).css("max-height",S.option.itemHeight)}})};var O=function(){if(this.option.listDirection==="down"){var R=this.inputView.offset().top+this.inputView.outerHeight()}else{if(this.option.listDirection==="up"){var R=this.inputView.offset().top-this.searchView.outerHeight()}else{throw"遇到未知的listDirection参数！"}}var Q=this.inputView.offset().left;this.searchView.css("top",R+"px").css("left",Q+"px")};var D=function(){if(typeof(this.option.width)==="string"&&this.option.width.toLowerCase()==="auto"){return this.inputView.outerWidth()-2}else{if(typeof(this.option.width)==="number"){return this.option.width}else{throw"遇到未知的width参数！"}}};var H=function(Q){var S=this;if(this.option.listDirection==="up"){Q=Q.reverse()}try{M.apply(S,[Q]);if(this.option.maxHeight>0){this.searchView.css("max-height",this.option.maxHeight+"px")}O.apply(this);this.searchView.css("width",D.apply(this)+"px")}catch(R){C.apply(this,[R+""]);return}this.searchView.show();E.apply(this,[this.option.listDirection])};var K=function(){this.searchView.find("ul").empty();this.searchView.hide()};var E=function(Q){var U=this.searchView.find("li.selected");if(U.size()){var T=Q==="up"?U.prev():U.next()}else{var T=Q==="up"?this.searchView.find("li").last():this.searchView.find("li").first()}if(T.size()){this.searchView.find("li").removeClass("selected");T.addClass("selected");var R=T.outerHeight();var S=T.position().top;if(R+S>this.searchView.height()){this.searchView.scrollTop(this.searchView.scrollTop()+S+R-this.searchView.height())}else{if(S<0){this.searchView.scrollTop(this.searchView.scrollTop()+S)}}}};var B=function(){var R=this,T=this.searchView.find("li.selected");if(T.size()){var S=T.data("data");this.inputView.val(S.value);if(L.isFunction(this.option.afterSelectedHandler)){try{this.option.afterSelectedHandler.apply(R,[S])}catch(Q){C.apply(this,["调用afterSelectedHandler错误:"+Q]);return}}K.apply(this)}};var J=function(S){jQuery.support.cors=true;var Q=this,T=[],R={"async":false,"dataType":Q.option.ajaxDataType,"type":Q.option.ajaxType,"timeout":this.option.ajaxTimeout,"success":function(V,U,W){if(Q.option.ajaxDataType==="xml"){L(V).find("item").each(function(){var Z={"value":L(this).text(),"label":L(this).text()};for(var Y=0;Y<this.attributes.length;Y++){var X=this.attributes[Y].nodeName,a=this.attributes[Y].nodeValue;Z[X]=a}T.push(Z)})}else{if(Q.option.ajaxDataType==="json"){T=V}else{throw"遇到未知的ajaxDataType参数！"}}},"error":function(U,W,V){throw V}};if(L.isPlainObject(this.option.ajaxParams)){R["data"]=L.extend(false,{"keyword":S},this.option.ajaxParams)}else{if(L.isFunction(this.option.ajaxParams)){R["data"]=L.extend(false,{"keyword":S},this.option.ajaxParams.apply(this,[S]))}else{if(typeof(this.option.ajaxParams)==="string"){R["data"]="keyword="+S+"&"+this.option.ajaxParams}else{throw"遇到未知的ajaxParams参数！"}}}L.ajax(this.option.data,R);return T};var F=function(){var R=this,U=this.inputView.val(),V=[],S=true,T=[];if(L.trim(U).length==0){K.apply(R);return}if(L.isFunction(this.option.beforeLoadDataHandler)){try{S=this.option.beforeLoadDataHandler.apply(this,[U])}catch(Q){C.apply(this,["调用beforeLoadDataHandler错误:"+Q]);return}}if(S){if(L.isArray(this.option.data)){V=this.option.data}else{if(L.isFunction(this.option.data)){try{V=this.option.data.apply(this,[U])}catch(Q){C.apply(this,["调用data错误:"+Q]);return}}else{if(typeof(this.option.data)==="string"){try{V=J.apply(this,[U])}catch(Q){C.apply(this,["Ajax错误:"+Q]);return}}else{C.apply(this,["遇到未知的data参数！"]);return}}}}L.each(V,function(Y,W){if(R.option.maxItems>0&&T.length>=R.option.maxItems){return false}if(L.isPlainObject(W)){var X=L.extend(false,{},W)}else{if(typeof(W)==="string"){var X={"label":W,"value":W,"image":W}}else{C.apply(R,["数据源Item类型错误！"]);return false}}if(R.option.matchHandler.apply(R,[U,X])){T.push(X)}});if(U==this.inputView.val()){if(T.length>0){H.apply(this,[T])}else{K.apply(this)}}};var C=function(Q){if(L.isFunction(this.option.onerror)){this.option.onerror.apply(this,[Q])}};N.prototype.setOption=function(Q){if(L.isPlainObject(Q)){this.option=L.extend(false,this.option,Q)}else{if(typeof(Q)==="string"){switch(Q){case"destroy":this.destroy();break;case"show":this.show();break;default:C.apply(this,["未知的AutoComplete参数！"]);return}}else{C.apply(this,["未知的AutoComplete参数类型！"]);return}}};N.prototype.destroy=function(){this.searchView.remove();this.inputView.unbind("keyup",this._keyup).unbind("keydown",this._keydown).unbind("blur",this._blur);delete this.inputView.get(0).controller};N.prototype.show=function(){if(this.option.async){setTimeout(function(){F.apply(this)},0)}else{F.apply(this)}};var A=function(R,S){var Q=RegExp(R.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i");if(this.option.emphasis&&L.isFunction(this.option.emphasisHandler)){this.option.emphasisHandler.apply(this,[R,S])}return Q.test(S.value)};var G=function(R,S){var Q=RegExp("("+R.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");S.label=S.label.replace(Q,"<em>$1</em>")}})(jQuery);